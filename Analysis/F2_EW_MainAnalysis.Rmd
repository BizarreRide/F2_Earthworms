---
title: "F2_Earthworms"
author:
  - name: FirstName LastName
    email: name@company.com
date: "`r Sys.Date()`"
e-mail: quentin.schorpp@ti.bund.de
output: 
      html_document:
          toc: true
          toc_depth: 3
          number_sections: true
          fig_caption: true
          theme: cerulean
          highlight: haddock
---
```{r SetGlobalOptions, include=FALSE}
knitr::opts_chunk$set(fig.align="center",
                      message=FALSE,
                      error=FALSE,
                      warning=FALSE,
                      echo=FALSE)
knitr::opts_knit$set(root.dir = 'D:/Quentin_Schorpp/Arbeitsprozess/git_repositories/F2_Earthworms/')

options(scipen=1, digits=2)
set.seed(1234)
```

```{r LoadData, results='hide'}
# Load Data
#setwd("D:/Quentin_Schorpp/Arbeitsprozess/git_repositories/F2_Earthworms/")
source("Data/GatherSource/Gather1.R")
source("Data/GatherSource/Gather2.R")
source("Data/GatherSource/Gather3.R")
source("Data/GatherSource/WaterContent.R")
```

```{r RequiredPackages}
source("Analysis/F2_EW_RequiredPackages.R")
source("Data/GatherSource/coldiss.R")
source("Data/GatherSource/panelutils.R")
source("Data/GatherSource/ggplotTheme.R")

lo <- par(mfrow=c(1,1))

overdisp_fun <- function(model) {
  ## number of variance parameters in 
  ##   an n-by-n variance-covariance matrix
  vpars <- function(m) {
    nrow(m)*(nrow(m)+1)/2
  }
  model.df <- sum(sapply(VarCorr(model),vpars))+length(fixef(model))
  rdf <- nrow(model.frame(model))-model.df
  rp <- residuals(model,type="pearson")
  Pearson.chisq <- sum(rp^2)
  prat <- Pearson.chisq/rdf
  pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
  c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)
}

```


# Introduction  

# Materials and methods  

# Analysis

*******************************************************************************************
### Variable Descriptions  

Earthworm species:             || Environmental:
:-------------------------------------|---|:-----------------------------------------------------
ACA - *Aporrectodea caliginosa*      || crop [Silphie, Maize]
ACH - *Allolobophora chlorotica*     || soiltype [Ut4, Lt, etc.]
ALO - *Apporectodea longa*           || pH
ARO - *Apporectodea rosea*           || CN [ratio]
END - Endogeic, *spec.*              || moist [volumetric %]
LCA - *Lumbricus castaneus*          || sand, silt, clay content [%]
LRU - *Lumbricus rubellus*           || ats = average soil temperature in 5cm depth [?C] 
LTR - *Lumbricus terrestris*         || ata = average air temperature in 2 m height [?C]
LUM - *Lumbricus spec.*              || atb = average air temperature in 20 cm height [?C]
OCY - *Octolasion cyaneum*           || hum = air humidity [%]
OLA - *Octolasion lacteum*           || prec = precipitation [mm]
UNK - Unknown                        || rad = radiation

___________________________________________________________________________________________________

**Spatial:**                         || **Temporal:** 
:-------------------------------------|---|:------------------------------------------------------
field.ID [Number, representing field] || season [autumn, spring]
field [Field code, DO_2004,etc.]      || age class [old, intermediate 2, intermediate 1, young, maize]
hole [hole; 1-4]                      || year [year of sampling; 2012,2013]
location [Name of county]             || date [da of sampling]
dgO [degree East, longitude]          || year established [2004,-05, -07, -09, 11]
dgN [degree North, latitude]          || age [age of field; y]


**Functional groups:** || 
---|---|---
anc - anecic  ||
endo - endogeic  ||
epi - epigeic||

___________________________________________________________________________________________________

> * Environmental data: 1 = Average of 30 days before sampling; 2 = Average of day of sampling  
  * _BM = Biomass values for Earthworm species in [g]  

___________________________________________________________________________________________________

## Exploratory Data Analysis (EDA)
**********************************

### Outlier
```{r Outlier}
climate <- c("ats1", "ats2", "hum1")
soil <- c("anc", "mc", "pH", "cn", "clay", "sand", "silt")

Mydotplot(data[,soil])

# I ound a mistake in calculation of soil water content, there are outliers in the fiedl replicates, that should be omitted
# in data analysis; New claculation leads to 25% Water content
# data[data$mc>25,"mc"] <- 25
```


### Density Plots
```{r DensityPlots, fig.height=6, fig.width=7}
par(mfrow=c(2,2))
plot(density(data$N), main="density-plot of total abundance")
plot(density(data$anc), main="density-plot of anecic abundance")
plot(density(data$epi), main="density-plot of epigeic abundance")
plot(density(data$endo), main="density-plot of endogeic abundance") # Outliers > 80 ?
```


### Scatterplots for all pairs of environmental variables
```{r EnvironmentalPairplots,message=FALSE, warning=FALSE, echo=FALSE}
# Choose interesting environmental parameters
env.chosen <- data[,c("anc", "mc", "pH", "cn", "clay", "ats1", "ats2", "hum1", "dgN", "dgO")]
env.chosen <- data[,c("anc", "ats1", "prec1","ats2", "hum2", "ata2", "prec2")]
env.chosen <- data[,c("anc", "age_class", "samcam")]
env.chosen <- data[,c("anc", "age_class", "dgO")]
env.chosen <- data[,c("anc", "age_class", "location")]

# Bivariate plots with histograms on the diagonal and smooth fitted curves
pairs(env.chosen, lower.panel=panel.smooth, upper.panel=panel.cor, method="pearson", diag.panel=panel.hist, main= "Bivariate Plots with Histograms and smooth curves\n(pearson)")
par(lo)

# correlated with anc:
# ats2, pH*cn, age_class, samcam, dgO
```


### Figures of real data for functional groups
Version 1 with "1st Order" data
```{r RealDataFigures1}

# create subset of real data with age_class, abundance (plus N) and biomass
data.raw.fig <- data[,c(which(colnames(data)=="age_class"),                      
                        which(colnames(data)=="anc"):which(colnames(data)=="epi"),
                        which(colnames(data)=="N"),
                        which(colnames(data)=="anc.bm"):which(colnames(data)=="epi.bm"),
                        which(colnames(data)=="N.bm"))]


# melt frame for use in ggplot
data.rf.melted <- melt(data.raw.fig, id.vars=c(1,6:9), variable="sfg", value.name="abundance")
data.rf.melted <- data.rf.melted[,c(1,6,7)]
data.rf.melted <- ddply(data.rf.melted, c("age_class", "sfg"), summarise, 
                          abc.n=length(abundance),
                          abc.sum=sum(abundance),
                          abc.mean=mean(abundance),
                          abc.sd=sd(abundance),
                          abc.se=abc.sd/sqrt(abc.n)) 

data.rf.melted2 <- melt(data.raw.fig, id.vars=c(1,2:5), variable="sfg.bm", value.name="biomass")
data.rf.melted2 <- data.rf.melted2[,c(1,6,7)]
data.rf.melted2 <- ddply(data.rf.melted2, c("age_class", "sfg.bm"), summarise, 
                          bm.n=length(biomass),
                          bm.sum=sum(biomass),
                          bm.mean=mean(biomass),
                          bm.sd=sd(biomass),
                          bm.se=bm.sd/sqrt(bm.n)) 

data.rf <- cbind(data.rf.melted,data.rf.melted2[,c(3:7)])

# Barplots
ggplot(data.rf, aes(x=age_class, y=4*abc.mean, fill=sfg)) +  
  geom_bar(stat="identity", position="dodge", colour="#454545", size=0.15) + 
  geom_errorbar(aes(ymin=4*abc.mean-4*abc.se, ymax=4*abc.mean+4*abc.se), position=position_dodge(0.9),width=0.15, size=0.15) +
  ggtitle("Data 1st Order") +
  xlab("Age Class") + 
  ylab("Abundance") +
  ylim(-10,max(data.rf$abc.mean+data.rf$abc.se)) +
  labs(fill="Functional Group") +
  scale_fill_grey(labels=c("anecic","endogeic", "epigeic", "total")) +
  scale_y_continuous(breaks=pretty_breaks(n=10)) +
  scale_x_discrete(labels=c("Cm", "Sp_Y", "Sp_I1", "Sp_I2", "Sp_O")) +  
  mytheme +
  theme(axis.text.x =element_text(angle=30, hjust=1, vjust=1),
        legend.position=c(0.18,0.68))
```

Version 2 with "2nd Order" data
```{r RealDataFigures2}
# create subset of real data2 with age_class, abundance (plus N) and biomass
data2.raw.fig <- data2[,c(which(colnames(data2)=="age_class"),                      
                        which(colnames(data2)=="anc"):which(colnames(data2)=="epi"),
                        which(colnames(data2)=="N"),
                        which(colnames(data2)=="anc.bm"):which(colnames(data2)=="epi.bm"),
                        which(colnames(data2)=="N.bm"))]


# melt frame for use in ggplot
data2.rf.melted <- melt(data2.raw.fig, id.vars=c(1,6:9), variable="sfg", value.name="abundance")
data2.rf.melted <- data2.rf.melted[,c(1,6,7)]
data2.rf.melted <- ddply(data2.rf.melted, c("age_class","sfg"), summarise, 
                          abc.n=length(abundance),
                          abc.sum=sum(abundance),
                          abc.mean=mean(abundance),
                          abc.sd=sd(abundance),
                          abc.se=abc.sd/sqrt(abc.n)) 

data2.rf.melted2 <- melt(data2.raw.fig, id.vars=c(1,2:5), variable="sfg.bm", value.name="biomass")
data2.rf.melted2 <- data2.rf.melted2[,c(1,6,7)]
data2.rf.melted2 <- ddply(data2.rf.melted2, c("age_class","sfg.bm"), summarise, 
                          bm.n=length(biomass),
                          bm.sum=sum(biomass),
                          bm.mean=mean(biomass),
                          bm.sd=sd(biomass),
                          bm.se=bm.sd/sqrt(bm.n)) 

data2.rf <- cbind(data2.rf.melted,data2.rf.melted2[,c(2:7)])

# Barplots
ggplot(data2.rf, aes(x=age_class, y=abc.mean, fill=sfg)) +  
  geom_bar(stat="identity", position="dodge", colour="#454545", size=0.15) + 
  geom_errorbar(aes(ymin=abc.mean-abc.se, ymax=abc.mean+abc.se), position=position_dodge(0.9),width=0.15, size=0.15) +
  ggtitle("Data 2nd Order") +
  xlab("Age Class") + 
  ylab("Abundance") +
  ylim(-10,max(data2.rf$abc.mean+data2.rf$abc.se)) +
  labs(fill="Functional Group") +
  scale_fill_grey(labels=c("anecic","endogeic", "epigeic", "total")) +
  scale_y_continuous(breaks=pretty_breaks(n=10)) +
  scale_x_discrete(labels=c("Cm", "Sp_Y", "Sp_I1", "Sp_I2", "Sp_O")) +  
  mytheme +
  theme(axis.text.x =element_text(angle=30, hjust=1, vjust=1),
        legend.position=c(0.18,0.68))

```

Version 3 with "3rd Order" data
```{r RealDataFigures3}
# create subset of real data2 with age_class, abundance (plus N) and biomass
data3.raw.fig <- data3[,c(which(colnames(data3)=="age_class"),                      
                        which(colnames(data3)=="anc"):which(colnames(data3)=="epi"),
                        which(colnames(data3)=="N"),
                        which(colnames(data3)=="anc.bm"):which(colnames(data3)=="epi.bm"),
                        which(colnames(data3)=="N.bm"))]


# melt frame for use in ggplot
data3.rf.melted <- melt(data3.raw.fig, id.vars=c(1,6:9), variable="sfg", value.name="abundance")
data3.rf.melted <- data3.rf.melted[,c(1,6,7)]
data3.rf.melted <- ddply(data3.rf.melted, c("age_class","sfg"), summarise, 
                          abc.n=length(abundance),
                          abc.sum=sum(abundance),
                          abc.mean=mean(abundance),
                          abc.sd=sd(abundance),
                          abc.se=abc.sd/sqrt(abc.n)) 

data3.rf.melted2 <- melt(data3.raw.fig, id.vars=c(1,2:5), variable="sfg.bm", value.name="biomass")
data3.rf.melted2 <- data3.rf.melted2[,c(1,6,7)]
data3.rf.melted2 <- ddply(data3.rf.melted2, c("age_class","sfg.bm"), summarise, 
                          bm.n=length(biomass),
                          bm.sum=sum(biomass),
                          bm.mean=mean(biomass),
                          bm.sd=sd(biomass),
                          bm.se=bm.sd/sqrt(bm.n)) 

data3.rf <- cbind(data3.rf.melted,data3.rf.melted2[,c(2:7)])

## Barplots ####

# Abundance
ggplot(data3.rf, aes(x=age_class, y=abc.mean, fill=sfg)) +  
  geom_bar(stat="identity", position="dodge", colour="#454545", size=0.15) + 
  geom_errorbar(aes(ymin=abc.mean-abc.se, ymax=abc.mean+abc.se), position=position_dodge(0.9),width=0.15, size=0.15) +
  ggtitle("Data 3rd Order") +
  xlab("Age Class") + 
  ylab("Abundance") +
  ylim(-10,max(data3.rf$abc.mean+data3.rf$abc.se)) +
  labs(fill="Functional Group") +
  scale_fill_grey(labels=c("anecic","endogeic", "epigeic", "total")) +
  scale_y_continuous(breaks=pretty_breaks(n=10)) +
  scale_x_discrete(labels=c("Cm", "Sp_Y", "Sp_I1", "Sp_I2", "Sp_O")) +  
  mytheme +
  theme(axis.text.x =element_text(angle=30, hjust=1, vjust=1),
        legend.position=c(0.18,0.68))


# ggsave("Figure1.pdf", width=9, height=7, units="cm", useDingbats=FALSE)
# ggsave("Figure1.png", width=9, height=7, units="cm")

# Biomass
ggplot(data3.rf, aes(x=age_class, y=bm.mean, fill=sfg)) +  
  geom_bar(stat="identity", position="dodge", colour="#454545", size=0.15) + 
  geom_errorbar(aes(ymin=bm.mean-bm.se, ymax=bm.mean+bm.se), position=position_dodge(0.9),width=0.15, size=0.15) +
  ggtitle("Data 3rd Order") +
  xlab("Age Class") + 
  ylab("Biomass") +
  ylim(-10,max(data3.rf$bm.mean+data3.rf$bm.se)) +
  labs(fill="Functional Group") +
  scale_fill_grey(labels=c("anecic","endogeic", "epigeic", "total")) +
  scale_y_continuous(breaks=pretty_breaks(n=10)) +
  scale_x_discrete(labels=c("Cm", "Sp_Y", "Sp_I1", "Sp_I2", "Sp_O")) +  
  mytheme +
  theme(axis.text.x =element_text(angle=30, hjust=1, vjust=1),
        legend.position=c(0.18,0.68)) 

# ggsave("Figure2.pdf", width=9, height=7, units="cm", useDingbats=FALSE)
# ggsave("Figure2.png", width=9, height=7, units="cm")
#####
```

> **Why are the error bars becoming larger and larger with the Order of the dataset?**

> One reason is that the standard error is the standard deviation divided by the squareroot of number of items.
The latter decreases with increasing order of dataset:  
The squareroot in 1st order is ``r sqrt(4*3*3)``  
The squareroot in 2nd order is ``r sqrt(3*3)``  
The squareroot in 3rd order is ``r sqrt(3)``   


```{r RemoveDatasets1, include=FALSE}
rm(data.raw.fig, data.rf, data.rf.melted, data.rf.melted2,
   data2.raw.fig, data2.rf, data2.rf.melted, data2.rf.melted2,
   data3.raw.fig, data3.rf, data3.rf.melted, data3.rf.melted2)
```
______________________________________________________________________________________________________________


## General linear Mixed Effects Models (GLMM) with 2nd order Data
*****************************************************************
The thought about using 2nd order data instead of 3rd order data is that, besides the response variables, not other covaraites have been assessed at that level.....
All covariates apply to the field level!!??

### Data Pre-Processing  
#### Standardize Explanatory Variables 
```{r DataPreProcessing1}
## Create variable d(delta)samcam as the time difference of each sampling date to the first date, that each field was sampled; first date is Zero for all fields. ####
data2$dsamcam <- with(data2, round(c(rep(0,15),date[16:30]-date[0:15],date[31:45]-date[1:15]),0))

## Standardize all explanatory variables ####

# extract all numerical variables
std.var <- data2[sapply(data2,is.numeric)]
which(colnames(std.var)=="ACA")
# exclude all response variables
std.var <- std.var[,-c(25:59)]

# standardize, each column is divided by their standard deviation, and the mean of each column is subtracted 
std.var <- as.data.frame(scale(std.var, center=TRUE, scale=TRUE))
colnames(std.var) <- paste("scl", colnames(std.var), sep = "_") # rename columns

data2 <- cbind(data2, std.var)
#----

```


### Anecic Abundance 
********************

#### GLM approach
```{r GLM_2ndOrder}

# Model Formulation
M1 <- glm(anc ~ age_class + dsamcam + age_class:dsamcam, family="poisson", data2)
summary(M1)

# Deviance
logLik(M1) 

# Fraction of explained variation in the response variable
100*((M1$null.deviance-M1$deviance)/M1$null.deviance) # Fraction of explained variation in the response variable


### Model validation ####

E1 <- resid(M1, type="pearson")
F1 <- fitted(M1)

env1 <- cbind(E1, F1, data2[,c("anc", "age_class", "dsamcam")])
env0 <- cbind(E1, F1,data2[,c("mc", "pH", "cn", "clay", "ats1", "ats2", "hum1","dgO")])

# plot residual versus all covariates in the model
par(mfrow=c(3,2),
    mar=c(3.8,4,1,3))
for (i in 1:5) {
  scatter.smooth(env1[,i],env1[,1], xlab=colnames(env1)[i])
}
par(mfrow=c(1,1))

# plot residuals versus all covariates NOT in the model
par(mfrow=c(4,3),
    mar=c(3.8,4,1,3))
for (i in 1:10) {
  scatter.smooth(env0[,i],env0[,1], xlab=colnames(env0)[i])
}
par(mfrow=c(1,1))

# Overdispersion
N <- nrow(data2)
p <- length(coef(M1))
Dispersion <- sum(E1^2)/(N-p)
Dispersion
#-----

```


#### GLMM approach
```{r GLMM_2ndOrder}

# Model Forumlation
M1 <- glmmadmb(anc ~ age_class + scl_pH + scl_cn + scl_mc + I(scl_ats1^2) + I(scl_hum1^2) + (1|samcam), family="nbinom",data2)
summary(M1)

dredge(M1)

M1 <-  glmmadmb(anc ~ age_class + scl_cn + I(scl_ats1^2) + (1|samcam), family="nbinom",data2)
M1 <-  glmer.nb(anc ~ age_class + scl_cn + I(scl_ats1^2) + (1|samcam),data2)

# Deviance
logLik(M1) 

anc.best <- M1

library(lsmeans)
lsmeans(anc.best, pairwise~age_class*samcam, adjust="tukey") 

## Model validation ####
E1 <- resid(M1, type="pearson")
F1 <- fitted(M1)

env1 <- cbind(E1, F1, data2[,c("anc", "age_class", "cn", "ats1","dsamcam")])
env0 <- cbind(E1, F1,data2[,c("mc", "pH", "clay", "ats2", "hum1","dgO")])

# plot residual versus all covariates in the model
par(mfrow=c(3,3),
    mar=c(3.8,4,1,3))
for (i in 1:7) {
  scatter.smooth(env1[,i],env1[,1], xlab=colnames(env1)[i])
}
par(mfrow=c(1,1))

# plot residual versus all covariates NOT in the model
par(mfrow=c(3,3),
    mar=c(3.8,4,1,3))
for (i in 1:8) {
  scatter.smooth(env0[,i],env0[,1], xlab=colnames(env0)[i])
}
par(mfrow=c(1,1))

# Overdispersion
N <- nrow(data2)
p <- length(coef(M1))+1 # The Plus "+1" used for determining the number of parameters(p) is due to the "k" of negative 
                        # binomial distribution
Dispersion <- sum(E1^2)/(N-p)
Dispersion
#----
```
_________________________________________________________________________________________



## General linear Mixed Effects Models with 1st order Data
**********************************************************

### Data Pre-Processing  
#### Standardize Explanatory Variables  
```{r DataProcessing}

## Create variable d(delta)samcam as the time difference of each sampling date to the first date, that each field was sampled; first date is Zero for all fields. ####
data$dsamcam <- with(data, round(c(rep(0,60),date[61:120]-date[1:60],date[121:180]-date[1:60]),0))

## Standardize all explanatory variables ####

# extract all numerical variables
std.var <- data[sapply(data,is.numeric)]
# exclude all response variables
std.var <- std.var[,-c(7:30,49:58)]

# standardize, each column is divided by their standard deviation, and the mean of each column is subtracted 
std.var <- as.data.frame(scale(std.var, center=TRUE, scale=TRUE))
colnames(std.var) <- paste("scl", colnames(std.var), sep = ".") # rename columns

data$area <- rep(0.25,180)

data <- cbind(data, std.var)


# Ordered or not??
# Since i found it too difficult to handle, i used non-ordered factors
data$age_class <- factor(data$age_class, ordered=TRUE)
data$samcam <- factor(data$samcam, ordered=FALSE)

#----
```


### Anecic Abundance
********************

#### Assess variability in random effects
```{r BoxPlots,echo=FALSE}

# Variability within sites
boxplot(anc~field.ID, data, col="grey", main="Variability within sites", xlab="sites orderd in decreasing age", ylab="anecic earthworm abundance")

# variability within sampling campaigns
boxplot(anc~samcam, data,col="grey", main="Variability within sampling campaigns", xlab="seasons:\n autumn2012, spring2013, autumn2013", ylab="anecic earthworm abundance")

# variability within sites and sampling campaigns
boxplot(anc~field.ID+samcam, data, las=2, col="grey", main="Variability within sites \n differing at sampling campaigns", xlab="field+seasons", ylab="anecic earthworm abundance")
```
  

#### GLMM using glmmADMB


##### Model Formulation
```{r GLMM_anc, cache=TRUE}
# Global Model

str(data)

# Model Formulation
anc.glob <- glmmadmb(anc ~ age_class*samcam + I(scl.mc^2) + scl.pH*scl.cn + I(scl.ats1^2) +I(scl.hum1^2) + (1|field.ID) + offset(log(area)),data=data,family="poisson")
# offsset is used due to the personal advice by T. Onkelinx:
# You better use an offset if you want to express the model in terms of m². Just add offset(log(0.25)) to the model. 

summary(anc.glob)

# Overdispersion
E1 <- resid(anc.glob, type="pearson")
N <- nrow(data)
p <- length(coef(anc.glob))+1 # The Plus "+1" used for determining the number of parameters(p) is due to the "k" of negative 
                              # binomial distribution
Dispersion <- sum(E1^2)/(N-p)
Dispersion

# Multimodel averaging
anc.dredge <- dredge(anc.glob)
head(anc.dredge,10)

# The best model with both glmer() and glmmadmb():
# anc.best <- glmer(anc ~ age_class*samcam + I(scl.ats1^2) + (1|field.ID) + offset(log(area)) ,data=data,family="poisson")
anc.best <- glmmadmb(anc ~ age_class*samcam + I(scl.ats1^2) + (1|field.ID) + offset(log(area)) ,data=data,family="poisson")
summary(anc.best)

# glmer has less dispersion

# A former "best model" with humidity as significant term and age_class as ordered factor
# anc.best <- glmmadmb(anc ~ age_class + scl.dsamcam + I(scl.ats1^2) +I(scl.hum1^2) + (1|field.ID) + offset(log(area)) ,data=data,family="poisson")
# summary(anc.best)
````

A former "best model" with humidity as significant term and age_class as ordered factor, found using dredge was
anc.best <- glmmadmb(anc ~ age_class + scl.dsamcam + I(scl.ats1^2) +I(scl.hum1^2) + (1|field.ID) + offset(log(area)) ,data=data,family="poisson")

##### Model Validation
```{r ModelValidation1_anc}
summary(anc.best)
summary(aov(anc.best))

confint(anc.best)
coefplot2(anc.best)


## Model validation ####
E1 <- resid(anc.best, type="pearson")
F1 <- fitted(anc.best, type="response")

# Dataset with all variables IN the model
env1 <- cbind(E1, F1, data[,c("anc", "age_class", "samcam", "ats1")])
# covariates NOT in the model
env0 <- cbind(E1, F1,data[,c("mc", "pH", "cn", "clay", "ats2", "hum1","dgO")])

# plot residual versus all covariates in the model
par(mfrow=c(2,3),
    mar=c(3.8,4,1,3))
for (i in 1:length(env1)) {
  scatter.smooth(env1[,i],env1[,1], xlab=colnames(env1)[i])
  abline(h=0, lty=2, col="red")
}
par(mfrow=c(1,1))

# plot residual versus all covariates NOT in the model
par(mfrow=c(3,3),
    mar=c(3.8,4,1,3))
for (i in 1:length(env0)) {
  scatter.smooth(env0[,i],env0[,1], xlab=colnames(env0)[i])
  abline(h=0, lty=2, col="red")
}
par(mfrow=c(1,1))

# Overdispersion
N <- nrow(data)
p <- length(coef(anc.best)) # The Plus "+1" used for determining the number of parameters(p) is due to the "k" of negative 
                        # binomial distribution
Dispersion <- sum(E1^2)/(N-p)
Dispersion
#####

overdisp_fun(anc.best)


# Deviance
logLik(anc.best) 

# Fraction of explained variation in the response variable
100*((anc.best$null.deviance-anc.best$deviance)/anc.best$null.deviance) # failed


# Plots of Predicted Values
par(mfrow=c(2,2))
plot(data$age_class,predict(anc.best, type="response"))
plot(data$samcam,predict(anc.best, type="response"))
plot(data$ats1^2,predict(anc.best, type="response"))
plot(data$hum1^2,predict(anc.best, type="response"))

# Plots of fitted Values
par(mfrow=c(2,2))
plot(data$age_class,F1)
plot(data$samcam,F1)
plot(data$ats1^2,F1)

par(lo)
```

Model validation 2
```{r ModelValidation2_anc,fig.width=8, fig.height=7}
# Model Validation 

E <- resid(anc.best, type="pearson")

par(mfrow=c(2,2))
par(mar=c(5,5,2,3))
plot(E~fitted(anc.best), ylab="Pearson Residuals", xlab="Fitted values") 
abline(h=0, lty=2)
hist(E, main = "", breaks = 20, cex.lab = 1.5, xlab = "Pearson Residuals")
plot(E ~ data$age_class, ylab="Pearson Residuals", xlab="Age Class")
abline(h=0, lty=2)
plot(E ~ data$ats1, ylab="Pearson Residuals", xlab="Age Class")
abline(h=0, lty=2)
````

##### Post-Hoc Multicomparisons
```{r PostHocMulticomparisons_anc}
data$ia.acl.smc <- interaction(data$age_class, data$samcam)
anc.tukey <- glmmadmb(anc ~ ia.acl.smc + I(scl.ats1^2) + (1|field.ID) + offset(log(area)) ,data=data,family="poisson")
summary(anc.tukey)


# Pairwise comparisons
anc.pairwise <- glht(anc.tukey, mcp(ia.acl.smc = "Tukey"))
anc.pw.ci <- confint(anc.pairwise)

names(anc.pw.ci)
anc.pw.sig <- which(anc.pw.ci$confint[,2]>0)
data.frame(names(anc.pw.sig))


# Plot Errorbars
ggplot(anc.pw.ci, aes(y = lhs, x = exp(estimate), xmin = exp(lwr), xmax = exp(upr))) + 
  geom_errorbarh() + 
  geom_point() + 
  geom_vline(xintercept = 1) +
  mytheme

# plot confidence intervals

par(mar=c(2,15,2,2))
plot(anc.pw.ci) # only maize is significantly different from all SIlphie fields. Within SIlphie there are no differences


```

##### Extract Predictions and plot predictions with error bars
```{r ExtractPredicitons}
anc.td = expand.grid(age_class=unique(data$age_class),
                     samcam = unique(data$samcam),               
                     scl.ats1 = mean(data$scl.ats1),
                     area = 1)

anc.pred <- cbind(anc.td, predict(anc.best, newdata = anc.td, interval = "confidence")) 

data$samcam2 <-  data$samcam # duplicate variable samcam to change facet labels
revalue


ggplot(anc.pred, aes(x = age_class, y = exp(fit), ymin = exp(lwr), ymax = exp(upr))) + 
  geom_bar(stat="identity",position = position_dodge(1), col="454545", fill="grey") +
  geom_errorbar(position = position_dodge(1),col="black",width=0.15, size=0.15) + 
  facet_grid(.~samcam) +
  geom_hline(xintercept = 1) +
  ylab("Abundance Ind./m²") +
  xlab("Age Class") +
  scale_x_discrete(labels=c("Cm", "Sp_Y", "Sp_I1", "Sp_I2", "Sp_O")) +
  mytheme


anc.pred <- within(anc.pred, {
  AIC <- AIC(anc.best)
  Rrandom <- summary(lm(fitted(anc.best)~ data$anc))$adj.r.squared
  Rsquared <- summary(lm(predict(anc.best, type="response")~ data$anc))$adj.r.squared  
})
head(anc.pred)

anc.stat = round(summary(anc.best)$coefficients[, c(3,4)],4)
anc.coef = coeftab(anc.best)

anc.env <- glmmadmb(anc ~ samcam + I(ats1^2) + (1|field.ID) + offset(log(area)),data=data,family="poisson")
anc.pvalue <- anova(anc.env, anc.best)$"Pr(>Chi)"

anc.OUT1 = anc.pred
anc.OUT2 = cbind(anc.stat,anc.coef,LogLikP=anc.pvalue[2],fixef=fixef(anc.best))
````

```{r WriteOut}
#write.table(anc.OUT1, "Predictions+Stats+ConfIntervals.csv", sep=";", append=TRUE)
#write.table(anc.OUT2, "Predictions+Stats+ConfIntervals.csv", sep=";", append=TRUE)
```

```{r PredictionPlot2}
anc.td = expand.grid(age_class=unique(data$age_class),
                     samcam = unique(data$samcam),               
                     scl.ats1 = seq(min(data$scl.ats1),max(data$scl.ats1), by=0.2),
                     area = 1)

anc.pred <- cbind(anc.td, predict(anc.best, newdata = anc.td, interval = "confidence")) 

ggplot(anc.pred, aes(x = scl.ats1, y = exp(fit), ymin = exp(lwr), ymax = exp(upr),col=samcam)) + 
  geom_errorbar(position = position_dodge(1)) + 
  geom_point(position = position_dodge(1)) +
  facet_grid(.~age_class) +
  mytheme
```


#### From simple linear model to more complexity
```{r SimpleREgression, cache=TRUE}
## from Zuur "A beginers Guide....", p.116 ff ####

# Simple linear regression model
plot(data$age_class, data$anc, xlab="Age Class",ylab="anecic abundance")
M0 <- lm(anc ~ age_class, data)
summary(M0)
summary(aov(M0))

## Model validation: ####

# Homogeneity of variance
par(mfrow=c(2,2))
plot(M0)
par(lo)

# normality of residuals
E0 <- resid(M0)
hist(E0, 
     main = "", 
     breaks = 20, 
     cex.lab = 1.5, 
     xlab = "Residuals")


# Independence
# There is inherent "dependency due to experimental design"; all samples with the same field.ID are intraclass correlated; samples taken on one field again on each sampling campaign are pseudoreplicated (Intrclass correlation for all samples from one sampling campaign??)
#  -> use generalized linear mixed models

# Dependence due to model misfit occurs if we omitted an important covariate or if we model the effect of a covariate as linear when it should have non-linear effect. Model misfit is assessed by plotting residuals versus each covariate in the model and also versus each covariate not in the model. 


par(lo)
plot(data$age_class,resid(M0))
plot(data$samcam,resid(M0))
abline(h = 0, lty = 2)
plot(data$field,resid(M0))
abline(h = 0, lty = 2)


# Including field: This model has 5 Regression coefficients for age_class and 17 for field
M1 <- lm(anc ~ age_class + field, data)
summary(M1) # Coefficients: (4 not defined because of singularities)??? 
            #  -> one of your variables is alinear combination of other explanatory variables or is constant.
            alias(M1)

par(mfrow=c(2,2))
plot(M1)


# The Question is now what to do with the covariate field. We cannot ignore it, as the model without it contains residual patterns. But if we include th covariate field in the model, we use 17 additional regression parameters, and the model allows only for statements and predictions applying to thos 18 fields, not for fields in general. 

#################################################
#Figure 1.3
par(mfrow = c(1,1), mar = c(5,5,3,2))
plot(x = as.numeric(data$age_class), 
     y = data$anc,
     xlab = "age_class",
     ylab = "Anecic abundance",
     cex.lab = 1.5,
     pch = 1,
     ylim = c(-10, 60))
abline(M0, lwd = 5)
abline(h = 0, lty = 2)

range(data$age_class)
md <- seq(1, 5, length = 10)

Beta <- coef(M0)
for (i in 1:10){
  mu <- Beta[1] + Beta[2] * md[i]
  yi <- rnorm(100, mean = mu, sd = summary(M0)$sigma) # sigma = residual standard error
	points(jitter(rep(md[i], 100)), jitter(yi), col = grey(0.5), pch = 16, cex = 1)
}
#################################################
````


#### GLMM with JAGS according to Analysis of honey bee pollination data from Zuur "A Beginenrs Guide,.."

```{r GLMM22}
xyplot(anc~samcam|age_class,
       xlab="Sampling Campaign", data=data2, col=1,
       ylab="Anecic Abundance", layout=c(3,2), groups=field.ID, type="l",
       strip=strip.custom(bg="white", par.strip.text = list(cex=1.2)),
       scales=list(alternating=T, x=list(relation="same"), y=list(relation="same")))

data2$age_class <- factor(data2$age_class, ordered=FALSE)

M1 <- glmer(anc ~ scl.dsamcam*age_class + (1|field.ID), data2, family=poisson)
summary(M1)

drop1(M1)

# Poisson GLMM using glmer
M1 <- glmer(anc ~ scl.dsamcam + age_class + (1|field.ID), data2, family=poisson)
summary(M1)

E1 <- resid(M1, type="pearson")
N <- nrow(data2)
p <- length(fixef(M1)) +1 
Overdispersion <- sum(E1^2)/(N-p)
Overdispersion

# Model Validation
F1 <- fitted(M1, type="response")
par(mfrow=c(2,2), mar=c(5,5,2,2))
plot(x = F1, y=E1, xlab="Fitted values (type=response)", ylab="Pearson residuals")
abline(h=0, lty=2)
plot(x=data2$dsamcam, y=E1, xlab="Sampling Campaign", ylab="Pearson residuals")
abline(h=0, lty=2)
boxplot(E1~age_class, data=data2, xlab="Age Class", ylab="Pearson residuals")
abline(h=0, lty=2)
boxplot(E1~field.ID, data=data2, xlab="field", ylab="Pearson residuals")
abline(h=0, lty=2)


## Poisson GLMM using JAGS #####

X <- model.matrix(~scl.dsamcam + factor(age_class), data=data2)

K <- ncol(X)
Nre <- length(unique(data2$field.ID))
win.data2 <- list(Y=data2$anc,
                  X=X,
                  N=nrow(data2),
                  re=data2$field.ID,
                  b0=rep(0,K),
                  B0=diag(0.0001,K),
                  a0=rep(0,Nre),
                  A0=diag(Nre))

sink("GLMM.txt")
cat("
    model{
    #1. Diffuse priors for regression parameters
    beta ~ dmnorm(b0[], B0[,])
    
    #Diffuse priors for random effect field.ID
    a ~ dmnorm(a0, tau.re * A0[,])
    num ~ dnorm(0,0.0016)
    denom ~ dnorm(0,1)
    sigma.re <- abs(num/denom)
    tau.re <- 1/(sigma.re*sigma.re)
    
    #2. Likelihood
    for (i in 1:N) {
          Y[i] ~ dpois(mu[i])
    log(mu[i]) <- eta[i]
    eta[i] <- inprod(beta[], X[i,]) + a[re[i]]
    
    #3. Discrepancy measures
    YNew[i] ~ dpois(mu[i])
    ExpY[i] <- mu[i]
    VarY[i] <- mu[i]
    PRes[i] <- (Y[i] - ExpY[i]) / sqrt(VarY[i])
    PResNew[i] <- (YNew[i] - ExpY[i]) / sqrt(VarY[i])
    D[i] <- pow(PRes[i],2)
    DNew[i] <- pow(PResNew[i],2)
    }
    
    beta65 <- beta[6] - beta[5]
    Fit <- sum(D[1:N])
    FitNew <- sum(DNew[1:N])
        }
    ", fill=TRUE)
sink()

inits1 <- function() {
  list(beta= rnorm(K,0,0.01),
        a=rnorm(Nre, 0, 1),
        num=runif(1,0,25),
        denom=runif(1,0,1)
         )
}

params1 <- c("beta","a","sigma.re","PRes","Fit","FitNew","beta65")

J0 <- jags(data = win.data2,
           inits=inits1,
           parameters=params1,
           model.file="GLMM.txt",
           n.thin=10,
           n.chains=3,
           n.burnin=25000,
           n.iter=35000)
#####

out <- J0$BUGSoutput
MyBUGSChains(out, c(uNames("beta",6),"sigma.re"))

OUT1 <- MyBUGSOutput(out, c(uNames("beta",6),"sigma.re"))

print(OUT1, digits=3)

mean(out$sims.list$FitNew > out$sims.list$Fit)
# 0.001666667
# In all cases, the sum of squared residuals of the model fitted to the actual data differs from that of the simulated data; hence we have serious model mis-specification. Most likely we have overdispersion.
Betas <- OUT1[1:6,1]
a <- out$mean$a
eta <- win.data2$X%*% Betas + as.vector(a[win.data2$re])
mu <- exp(eta)
E  <- out$mean$PRes
sum(E^2) / (nrow(data2) - p)

plot(mu,E)
abline(h=0, lty=2)

# Negative binomial GLMM using glmmADMB
M2 <- glmmadmb(anc ~ scl.dsamcam + age_class + (1|field.ID), data2, family="nbinom")
summary(M2)

E2 <- resid(M2, type="pearson")
p <- 6 +1 +1 # Number of betas +k +sigma
Overdispersion2 <- sum(E2^2)/(N-p)
Overdispersion

## Negative binomial GLMM using JAGS ####
F2 <- fitted(M2, type="response")
par(mfrow=c(2,2), mar=c(5,5,2,2))
plot(x = F2, y=E2, xlab="Fitted values (type=response)", ylab="Pearson residuals")
abline(h=0, lty=2)
plot(x=data2$dsamcam, y=E2, xlab="Sampling Campaign", ylab="Pearson residuals")
abline(h=0, lty=2)
boxplot(E2~age_class, data=data2, xlab="Age Class", ylab="Pearson residuals")
abline(h=0, lty=2)
boxplot(E2~field.ID, data=data2, xlab="field", ylab="Pearson residuals")
abline(h=0, lty=2)

sink("GLMM_NB.txt")
cat("
    model{
    #1. Diffuse priors for regression parameters
    beta ~ dmnorm(b0[], B0[,])
    
    #Diffuse priors for random effect field.ID
    a ~ dmnorm(a0, tau.re * A0[,])
    num ~ dnorm(0,0.0016)
    denom ~ dnorm(0,1)
    sigma.re <- abs(num/denom)
    tau.re <- 1/(sigma.re*sigma.re)
    
    #Prior for size
    numS ~ dnorm(0,0.0016)
    denomS ~ dnorm(0,1)
    size <- abs(nums/denomS)
    
    
    #2. Likelihood
    for (i in 1:N) {
          Y[i] ~ dnegbin(p[i], size)
    p[i]  <- size/(size+mu[i])
    log(mu[i]) <- eta[i]
    eta[i] <- inprod(beta[], X[i,]) + a[re[i]]
    
    #3. Discrepancy measures
    YNew[i] ~ dpois(mu[i])
    ExpY[i] <- mu[i]
    VarY[i] <- mu[i] + pow(mu[i],2) / size
    PRes[i] <- (Y[i] - ExpY[i]) / sqrt(VarY[i])
    PResNew[i] <- (YNew[i] - ExpY[i]) / sqrt(VarY[i])
    D[i] <- pow(PRes[i],2)
    DNew[i] <- pow(PResNew[i],2)
    }
    
    beta65 <- beta[6] - beta[5]
    Fit <- sum(D[1:N])
    FitNew <- sum(DNew[1:N])
        }
    ", fill=TRUE)
sink()

inits2 <- function() {
  list(beta= rnorm(K,0,0.01),
        a=rnorm(Nre, 0, 1),
        num=runif(1,0,25),
        denom=runif(1,0,1),
        numS = rnorm(1,0,25),
        denomS = rnorm(1,0,1)
         )
}

params1 <- c("beta","a","sigma.re","PRes","Fit","FitNew","beta65")


N0 <- jags(data = win.data2,
           inits=inits1,
           parameters=params1,
           model.file="GLMM.txt",
           n.thin=10,
           n.chains=3,
           n.burnin=25000,
           n.iter=30000)

N1 <- update(N0, n.iter = 20000)
N2 <- update(N1, n.iter = 50000)
#####

out <- N2$BUGSoutput
MyBUGSChains(out, c(uNames("beta",6),"sigma.re"))

OUT1 <- MyBUGSOutput(out, c(uNames("beta",6),"sigma.re"))

print(OUT1, digits=3) # the results of JAGS are similar to the summary output of glmmadmb


# Overdispersion
# We extract the posterios mean values of the Pearson residuals.
E  <- out$mean$PRes
p <- 6+1
sum(E^2) / (nrow(data2) - p)

# Another method of assessing overdispersion; via the bayesian p-value the chains of Fit and FitNEw are compared.
# We count the number of times that the newly generated data provide a sum of squared pearson residuals that is larger than 
# that of the observed data. An average of 0.5 means that the data is similar to the observed data, indicating that the model fits the data well
# Values close to 0 or 1 would indicate problems

mean(out$sims.list$FitNew > out$sims.list$Fit)
# 0.0009733333
#

# Model Valdation
#Model validation
Betas <- OUT1[1:6,1]
a     <- out$mean$a
eta   <- win.data1$X %*% Betas + as.vector(a[win.data1$re])
mu    <- exp(eta)

par(mfrow = c(2,2), mar = c(5,5,2,2))
plot(x = mu, y = E,
     xlab = "Fitted values",
     ylab = "Pearson resiuals",
     cex.lab = 1.5)
abline(h=0, lty = 2)
     
plot(x=data2$dsamcam, y = E,
     xlab = "delta Sampling campaign (days)",
     ylab = "Pearson resiuals",
     cex.lab = 1.5)
abline(h=0, lty = 2)

boxplot(E ~ age_class, data = data2,
     xlab = "Age_Class",
     ylab = "Pearson resiuals",
     cex.lab = 1.5)
abline(h=0, lty = 2)

boxplot(E ~ field.ID, data = data2,
     xlab = "Field",
     ylab = "Pearson resiuals",
     cex.lab = 1.5)
abline(h=0, lty = 2)


MyData <- expand.grid(scl.dsamcam = seq(min(data2$scl.dsamcam),max(data2$scl.dsamcam),length = 10),
                      age_class = levels(data2$age_class)) 
Z <- model.matrix(~scl.dsamcam + age_class, data = MyData)
MyData$eta <- Z %*% Betas
MyData$mu  <- exp(MyData$eta)

#And for the random effects:
Betas <- OUT1[1:6,1]
a <- out$mean$a
eta <- win.data2$X %*% Betas 
RE  <- a[win.data2$re]
eta <- as.vector(eta) + RE
mu  <- exp(eta)


xyplot(anc ~ scl.dsamcam | age_class, 
       xlab = list("Time (days)", cex = 1.5),
       ylab = list("Number of anecic earthworms", cex = 1.5),
       data = data2, layout = c(3,2),
       type = "p", col = 1,
       strip = strip.custom(bg = 'white',
                            par.strip.text = list(cex = 1.2)),
       scales = list(alternating = T,
                     x = list(relation = "same"),
                     y = list(relation = "same")),
                     
       panel = function(x,y, subscripts,...){
         ID <- data2$age_class[subscripts][1]
       	x1 <- MyData[data2$age_class == ID,"scl.dsamcam"]
       	y1 <- MyData[data2$age_class == ID,"mu"]
       	panel.lines(x1,y1, lwd = 5, col =1)
       	panel.points(x,y, pch = 16, col = 1)
       	
       	xx1 <- data2$scl.dsamcam[subscripts]
       	yy1 <- mu[subscripts]
       	Hives <- data$field.ID[subscripts]
       	NH <- unique(data2$field.ID)
       	for (i in 1:4){
       	panel.lines(xx1[data2$field.ID==NH[i]],
       	            yy1[data2$field.ID==NH[i]], 
       	            lwd = 1, col = 1)
       }}             
)


```


_________________________________________________________________________________________________________________________


### Endogeic Abundance
**********************

#### Assess variability of random effects
```{r BoxPlots,echo=FALSE}
par(lo)

# Variability within sites
boxplot(endo~field.ID, data, col="grey", main="Variability within sites", xlab="sites orderd in decreasing age", ylab="anecic earthworm abundance")

# variability within sampling campaigns
boxplot(endo~samcam, data,col="grey", main="Variability within sampling campaigns", xlab="seasons:\n autumn2012, spring2013, autumn2013", ylab="anecic earthworm abundance")

# variability within sites and sampling campaigns
boxplot(endo~field.ID+samcam, data, las=2, col="grey", main="Variability within sites \n differing at sampling campaigns", xlab="field+seasons", ylab="anecic earthworm abundance")
```
 
#### GLMM using glmmADMB

##### Model Formulation
```{r GLMM_anc, cache=TRUE}
# Global Model

str(data)

# Model Formulation
endo.glob <- glmmadmb(endo ~ age_class + samcam + I(scl.mc^2) + scl.pH*scl.cn + scl.ats1 + (1|field.ID) + offset(log(area)),data=data,family="nbinom")
# offsset is used due to the personal advice by T. Onkelinx:
# You better use an offset if you want to express the model in terms of m². Just add offset(log(0.25)) to the model. 

summary(endo.glob)

# Overdispersion
E1 <- resid(endo.glob, type="pearson")
N <- nrow(data)
p <- length(coef(endo.glob))+1 # The Plus "+1" used for determining the number of parameters(p) is due to the "k" of negative binomial distribution
Dispersion <- sum(E1^2)/(N-p)
Dispersion

# Multimodel averaging
endo.dredge <- dredge(endo.glob)
head(endo.dredge,10)

# The best model with both glmer() and glmmadmb():
# endo.best <- glmer(endo ~ age_class*samcam + I(scl.ats1^2) + (1|field.ID) + offset(log(area)) ,data=data,family="poisson")
endo.best <- glmmadmb(endo ~ age_class + samcam + scl.pH + (1|field.ID) + offset(log(area)) ,data=data,family="poisson")
summary(endo.best)

# glmer has less dispersion

# A former "best model" with humidity as significant term and age_class as ordered factor
# endo.best <- glmmadmb(endo ~ age_class + scl.dsamcam + I(scl.ats1^2) +I(scl.hum1^2) + (1|field.ID) + offset(log(area)) ,data=data,family="poisson")
# summary(endo.best)
````

A former "best model" with humidity as significant term and age_class as ordered factor, found using dredge was
anc.best <- glmmadmb(anc ~ age_class + scl.dsamcam + I(scl.ats1^2) +I(scl.hum1^2) + (1|field.ID) + offset(log(area)) ,data=data,family="poisson")







# Results

### README
```{r CreateREADME.md, }
#setwd("D:/Quentin_Schorpp/Arbeitsprozess/git_repositories/F2_Earthworms/")
knitr::knit(input="README.Rmd", output="README.md") # Error: no such file or directory, when trying knitHTML
```



