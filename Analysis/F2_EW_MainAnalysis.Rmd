---
title: "F2_Earthworms"
author:
  - name: FirstName LastName
    email: name@company.com
date: "`r Sys.Date()`"
e-mail: quentin.schorpp@ti.bund.de
output: 
      html_document:
          toc: true
          toc_depth: 3
          number_sections: true
          fig_caption: true
          theme: cerulean
          highlight: haddock
---
```{r SetGlobalOptions, include=FALSE}
knitr::opts_chunk$set(fig.align="center",
                      message=FALSE,
                      error=FALSE,
                      warning=FALSE,
                      echo=FALSE)
knitr::opts_knit$set(root.dir = 'D:/Quentin_Schorpp/Arbeitsprozess/git_repositories/F2_Earthworms/')

options(scipen=1, digits=2)
set.seed(1234)
```

```{r LoadData, results='hide'}
# Load Data
#setwd("D:/Quentin_Schorpp/Arbeitsprozess/git_repositories/F2_Earthworms/")
source("Data/GatherSource/Gather1.R")
source("Data/GatherSource/Gather2.R")
source("Data/GatherSource/Gather3.R")
```

```{r RequiredPackages}
source("Analysis/F2_EW_RequiredPackages.R")
source("Data/GatherSource/coldiss.R")
source("Data/GatherSource/panelutils.R")
source("Data/GatherSource/ggplotTheme.R")

MyNorm <- function(x) {(x - mean(x))/ sd(x)}
```


# Introduction  

# Materials and methods  

# Analysis

*******************************************************************************************
### Variable Descriptions  

Earthworm species:             || Environmental:
:-------------------------------------|---|:-----------------------------------------------------
ACA - *Aporrectodea caliginosa*      || crop [Silphie, Maize]
ACH - *Allolobophora chlorotica*     || soiltype [Ut4, Lt, etc.]
ALO - *Apporectodea longa*           || pH
ARO - *Apporectodea rosea*           || CN [ratio]
END - Endogeic, *spec.*              || moist [volumetric %]
LCA - *Lumbricus castaneus*          || sand, silt, clay content [%]
LRU - *Lumbricus rubellus*           || ats = average soil temperature in 5cm depth [?C] 
LTR - *Lumbricus terrestris*         || ata = average air temperature in 2 m height [?C]
LUM - *Lumbricus spec.*              || atb = average air temperature in 20 cm height [?C]
OCY - *Octolasion cyaneum*           || hum = air humidity [%]
OLA - *Octolasion lacteum*           || prec = precipitation [mm]
UNK - Unknown                        || rad = radiation

___________________________________________________________________________________________________

**Spatial:**                         || **Temporal:** 
:-------------------------------------|---|:------------------------------------------------------
field.ID [Number, representing field] || season [autumn, spring]
field [Field code, DO_2004,etc.]      || age class [old, intermediate 2, intermediate 1, young, maize]
hole [hole; 1-4]                      || year [year of sampling; 2012,2013]
location [Name of county]             || date [da of sampling]
dgO [degree East, longitude]          || year established [2004,-05, -07, -09, 11]
dgN [degree North, latitude]          || age [age of field; y]


**Functional groups:** || 
---|---|---
anc - anecic  ||
endo - endogeic  ||
epi - epigeic||

___________________________________________________________________________________________________

> * Environmental data: 1 = Average of 30 days before sampling; 2 = Average of day of sampling  
  * _BM = Biomass values for Earthworm species in [g]  

___________________________________________________________________________________________________

## Exploratory Data Analysis (EDA)

### Density Plots
```{r DensityPlots, fig.height=6, fig.width=7}
par(mfrow=c(2,2))
plot(density(data$N), main="density-plot of total abundance")
plot(density(data$anc), main="density-plot of anecic abundance")
plot(density(data$epi), main="density-plot of epigeic abundance")
plot(density(data$endo), main="density-plot of endogeic abundance") # Outliers > 80 ?
```

### Scatterplots for all pairs of environmental variables
```{r EnvironmentalPairplots,message=FALSE, warning=FALSE, echo=FALSE}
# Choose interesting environmental parameters
env.chosen <- data[,c("anc", "mc", "pH", "cn", "clay", "ats1", "ats2", "hum1", "dgN", "dgO")]
env.chosen <- data[,c("anc", "ats1", "prec1","ats2", "hum2", "ata2", "prec2")]
env.chosen <- data[,c("anc", "age_class", "samcam")]
env.chosen <- data[,c("anc", "age_class", "dgO")]
env.chosen <- data[,c("anc", "age_class", "location")]

# Bivariate plots with histograms on the diagonal and smooth fitted curves
op <- par(mfrow=c(1,1), pty="s")
pairs(env.chosen, lower.panel=panel.smooth, upper.panel=panel.cor, method="pearson", diag.panel=panel.hist, main= "Bivariate Plots with Histograms and smooth curves\n(pearson)")
par(op)

# correlated with anc:
# ats2, pH*cn, age_class, samcam, dgO
```


### Figures of real data for functional groups
```{r RealDataFigures}

# create subset of real data with age_class, abundance (plus N) and biomass
data.raw.fig <- data[,c(which(colnames(data)=="age_class"),                      
                        which(colnames(data)=="anc"):which(colnames(data)=="epi"),
                        which(colnames(data)=="N"),
                        which(colnames(data)=="anc.bm"):which(colnames(data)=="epi.bm"),
                        which(colnames(data)=="N.bm"))]


# melt frame for use in ggplot
data.rf.melted <- melt(data.raw.fig, id.vars=c(1,6:9), variable="sfg", value.name="abundance")
data.rf.melted <- data.rf.melted[,c(1,6,7)]
data.rf.melted <- ddply(data.rf.melted, c("age_class", "sfg"), summarise, 
                          abc.n=length(abundance),
                          abc.sum=sum(abundance),
                          abc.mean=mean(abundance),
                          abc.sd=sd(abundance),
                          abc.se=abc.sd/sqrt(abc.n)) 

data.rf.melted2 <- melt(data.raw.fig, id.vars=c(1,2:5), variable="sfg.bm", value.name="biomass")
data.rf.melted2 <- data.rf.melted2[,c(1,6,7)]
data.rf.melted2 <- ddply(data.rf.melted2, c("age_class", "sfg.bm"), summarise, 
                          bm.n=length(biomass),
                          bm.sum=sum(biomass),
                          bm.mean=mean(biomass),
                          bm.sd=sd(biomass),
                          bm.se=bm.sd/sqrt(bm.n)) 

data.rf <- cbind(data.rf.melted,data.rf.melted2[,c(3:7)])

# Barplots
ggplot(data.rf, aes(x=age_class, y=4*abc.mean, fill=sfg)) +  
  geom_bar(stat="identity", position="dodge", colour="#454545", size=0.15) + 
  geom_errorbar(aes(ymin=4*abc.mean-4*abc.se, ymax=4*abc.mean+4*abc.se), position=position_dodge(0.9),width=0.15, size=0.15) +
  ggtitle("Data 1st Order") +
  xlab("Age Class") + 
  ylab("Abundance") +
  ylim(-10,max(data.rf$abc.mean+data.rf$abc.se)) +
  labs(fill="Functional Group") +
  scale_fill_grey(labels=c("anecic","endogeic", "epigeic", "total")) +
  scale_y_continuous(breaks=pretty_breaks(n=10)) +
  scale_x_discrete(labels=c("Cm", "Sp_Y", "Sp_I1", "Sp_I2", "Sp_O")) +  
  mytheme +
  theme(axis.text.x =element_text(angle=30, hjust=1, vjust=1),
        legend.position=c(0.18,0.68))
```

Version 2 with "2nd Order" data
```{r}
# create subset of real data2 with age_class, abundance (plus N) and biomass
data2.raw.fig <- data2[,c(which(colnames(data2)=="age_class"),                      
                        which(colnames(data2)=="anc"):which(colnames(data2)=="epi"),
                        which(colnames(data2)=="N"),
                        which(colnames(data2)=="anc.bm"):which(colnames(data2)=="epi.bm"),
                        which(colnames(data2)=="N.bm"))]


# melt frame for use in ggplot
data2.rf.melted <- melt(data2.raw.fig, id.vars=c(1,6:9), variable="sfg", value.name="abundance")
data2.rf.melted <- data2.rf.melted[,c(1,6,7)]
data2.rf.melted <- ddply(data2.rf.melted, c("age_class","sfg"), summarise, 
                          abc.n=length(abundance),
                          abc.sum=sum(abundance),
                          abc.mean=mean(abundance),
                          abc.sd=sd(abundance),
                          abc.se=abc.sd/sqrt(abc.n)) 

data2.rf.melted2 <- melt(data2.raw.fig, id.vars=c(1,2:5), variable="sfg.bm", value.name="biomass")
data2.rf.melted2 <- data2.rf.melted2[,c(1,6,7)]
data2.rf.melted2 <- ddply(data2.rf.melted2, c("age_class","sfg.bm"), summarise, 
                          bm.n=length(biomass),
                          bm.sum=sum(biomass),
                          bm.mean=mean(biomass),
                          bm.sd=sd(biomass),
                          bm.se=bm.sd/sqrt(bm.n)) 

data2.rf <- cbind(data2.rf.melted,data2.rf.melted2[,c(2:7)])

# Barplots
ggplot(data2.rf, aes(x=age_class, y=abc.mean, fill=sfg)) +  
  geom_bar(stat="identity", position="dodge", colour="#454545", size=0.15) + 
  geom_errorbar(aes(ymin=abc.mean-abc.se, ymax=abc.mean+abc.se), position=position_dodge(0.9),width=0.15, size=0.15) +
  ggtitle("Data 2nd Order") +
  xlab("Age Class") + 
  ylab("Abundance") +
  ylim(-10,max(data2.rf$abc.mean+data2.rf$abc.se)) +
  labs(fill="Functional Group") +
  scale_fill_grey(labels=c("anecic","endogeic", "epigeic", "total")) +
  scale_y_continuous(breaks=pretty_breaks(n=10)) +
  scale_x_discrete(labels=c("Cm", "Sp_Y", "Sp_I1", "Sp_I2", "Sp_O")) +  
  mytheme +
  theme(axis.text.x =element_text(angle=30, hjust=1, vjust=1),
        legend.position=c(0.18,0.68))

```

Version 3 with "3rd Order" data
```{r}
# create subset of real data2 with age_class, abundance (plus N) and biomass
data3.raw.fig <- data3[,c(which(colnames(data3)=="age_class"),                      
                        which(colnames(data3)=="anc"):which(colnames(data3)=="epi"),
                        which(colnames(data3)=="N"),
                        which(colnames(data3)=="anc.bm"):which(colnames(data3)=="epi.bm"),
                        which(colnames(data3)=="N.bm"))]


# melt frame for use in ggplot
data3.rf.melted <- melt(data3.raw.fig, id.vars=c(1,6:9), variable="sfg", value.name="abundance")
data3.rf.melted <- data3.rf.melted[,c(1,6,7)]
data3.rf.melted <- ddply(data3.rf.melted, c("age_class","sfg"), summarise, 
                          abc.n=length(abundance),
                          abc.sum=sum(abundance),
                          abc.mean=mean(abundance),
                          abc.sd=sd(abundance),
                          abc.se=abc.sd/sqrt(abc.n)) 

data3.rf.melted2 <- melt(data3.raw.fig, id.vars=c(1,2:5), variable="sfg.bm", value.name="biomass")
data3.rf.melted2 <- data3.rf.melted2[,c(1,6,7)]
data3.rf.melted2 <- ddply(data3.rf.melted2, c("age_class","sfg.bm"), summarise, 
                          bm.n=length(biomass),
                          bm.sum=sum(biomass),
                          bm.mean=mean(biomass),
                          bm.sd=sd(biomass),
                          bm.se=bm.sd/sqrt(bm.n)) 

data3.rf <- cbind(data3.rf.melted,data3.rf.melted2[,c(2:7)])

## Barplots ####

# Abundance
ggplot(data3.rf, aes(x=age_class, y=abc.mean, fill=sfg)) +  
  geom_bar(stat="identity", position="dodge", colour="#454545", size=0.15) + 
  geom_errorbar(aes(ymin=abc.mean-abc.se, ymax=abc.mean+abc.se), position=position_dodge(0.9),width=0.15, size=0.15) +
  ggtitle("Data 3rd Order") +
  xlab("Age Class") + 
  ylab("Abundance") +
  ylim(-10,max(data3.rf$abc.mean+data3.rf$abc.se)) +
  labs(fill="Functional Group") +
  scale_fill_grey(labels=c("anecic","endogeic", "epigeic", "total")) +
  scale_y_continuous(breaks=pretty_breaks(n=10)) +
  scale_x_discrete(labels=c("Cm", "Sp_Y", "Sp_I1", "Sp_I2", "Sp_O")) +  
  mytheme +
  theme(axis.text.x =element_text(angle=30, hjust=1, vjust=1),
        legend.position=c(0.18,0.68))


# ggsave("Figure1.pdf", width=9, height=7, units="cm", useDingbats=FALSE)
# ggsave("Figure1.png", width=9, height=7, units="cm")

# Biomass
ggplot(data3.rf, aes(x=age_class, y=bm.mean, fill=sfg)) +  
  geom_bar(stat="identity", position="dodge", colour="#454545", size=0.15) + 
  geom_errorbar(aes(ymin=bm.mean-bm.se, ymax=bm.mean+bm.se), position=position_dodge(0.9),width=0.15, size=0.15) +
  ggtitle("Data 3rd Order") +
  xlab("Age Class") + 
  ylab("Biomass") +
  ylim(-10,max(data3.rf$bm.mean+data3.rf$bm.se)) +
  labs(fill="Functional Group") +
  scale_fill_grey(labels=c("anecic","endogeic", "epigeic", "total")) +
  scale_y_continuous(breaks=pretty_breaks(n=10)) +
  scale_x_discrete(labels=c("Cm", "Sp_Y", "Sp_I1", "Sp_I2", "Sp_O")) +  
  mytheme +
  theme(axis.text.x =element_text(angle=30, hjust=1, vjust=1),
        legend.position=c(0.18,0.68)) 

# ggsave("Figure2.pdf", width=9, height=7, units="cm", useDingbats=FALSE)
# ggsave("Figure2.png", width=9, height=7, units="cm")
#####
```

> **Why are the error bars becoming larger and larger with the Order of the dataset?**

> One reason is that the standard error is the standard deviation divided by the squareroot of number of items.
The latter decreases with increasing order of dataset:  
The squareroot in 1st order is ``r sqrt(4*3*3)``  
The squareroot in 2nd order is ``r sqrt(3*3)``  
The squareroot in 3rd order is ``r sqrt(3)``   


```{r RemoveDatasets1, include=FALSE}
rm(data.raw.fig, data.rf, data.rf.melted, data.rf.melted2,
   data2.raw.fig, data2.rf, data2.rf.melted, data2.rf.melted2,
   data3.raw.fig, data3.rf, data3.rf.melted, data3.rf.melted2)
```

______________________________________________________________________________________________________________

## General linear Mixed Effects Models with 2nd order Data

The thought about using 2nd order data instead of 3rd order data is that, besides the response variables, not other covaraites have been assessed at that level.....
All covariates apply to the field level!!??




## General linear Mixed Effects Models with 3rd order Data

### Data Pre-Processing  
#### Standardize Explanatory Variables  
```{r DataProcessing}

## Create variable d(delta)samcam as the time difference of each sampling date to the first date, that each field was sampled; first date is Zero for all fields. ####
data$dsamcam <- with(data, round(c(rep(0,60),date[61:120]-date[1:60],date[121:180]-date[1:60]),0))

## Standardize all explanatory variables ####

# extract all numerical variables
std.var <- data[sapply(data,is.numeric)]
# exclude all response variables
std.var <- std.var[,-c(7:30,49:58)]

# standardize, each column is divided by their standard deviation, and the mean of each column is subtracted 
std.var <- as.data.frame(scale(std.var, center=TRUE, scale=TRUE))
colnames(std.var) <- paste("scl", colnames(std.var), sep = ".") # rename columns

data <- cbind(data, std.var)
#----
```



### Anecic Abundance


```{r BoxPlots,echo=FALSE}

# Variability within sites
boxplot(anc~field.ID, data, col="grey", main="Variability within sites", xlab="sites orderd in decreasing age", ylab="anecic earthworm abundance")

# variability within sampling campaigns
boxplot(anc~samcam, data,col="grey", main="Variability within sampling campaigns", xlab="seasons:\n autumn2012, spring2013, autumn2013", ylab="anecic earthworm abundance")

# variability within sampling campaigns
boxplot(anc~field.ID+samcam, data, las=2, col="grey", main="Variability within sites \n differing at sampling campaigns", xlab="field+seasons", ylab="anecic earthworm abundance")
```
     

```{r GLMM, cache=TRUE}
## from Zuur "A beginers Guide....", p.116 ff ####

# linear regression model
plot(data$age_class, data$anc, xlab="Age Class",ylab="anecic abundance")
M0 <- lm(anc ~ age_class, data)
abline(M0, lwd=3)
summary(M0)

plot(data$age_class,resid(M0))
plot(data$field,resid(M0))

env.chosen <- cbind(resid(M0),data[,c("anc", "mc", "pH", "cn", "clay", "ats1", "ats2", "hum1", "age_class", "dgO","dsamcam")])

par(mfrow=c(4,3),
    mar=c(3.8,4,1,3))
for (i in 1:12) {
  scatter.smooth(env.chosen[,i],env.chosen[,1], xlab=colnames(env.chosen)[i])
}
par(mfrow=c(1,1))

par(mfrow=c(4,3),
    mar=c(3.8,4,1,3))
for (i in 1:12) {
  scatter.smooth(env.chosen[,i],env.chosen[,2], xlab=colnames(env.chosen)[i])
}
par(mfrow=c(1,1))

# Including field: This models has 5 Regression coefficients for age_class and 17 for field
M1 <- lm(anc ~ age_class + field, data)
summary(M1) # Coefficients: (4 not defined because of singularities)??? 
            #  -> one of your variables is alinear combination of other explanatory variables or is constant.
alias(M1)


summary(aov(M1))
plot(data$hum1, data$anc, xlab="Age Class",ylab="anecic abundance")
abline(M1, lwd=3)




# The Question is now what to do with the covariate field. We cannot ignore it, as the model without it contains residual patterns. But if we include th covariate field in the model, we use 17 additional regression parameters, and the model allows only for statements and predictions applying to thos 18 fields, not for fields in general. 
````


```{r glmm}
M2 <- lmer(anc ~ age_class + scl.dsamcam + scl.ats1 +scl.hum1 + scl.pH + (1|field.ID), data)
M2 <- lmer(anc ~ age_class + scl.dsamcam + I(scl.ats1^2) +I(scl.hum1^2) + scl.pH + (1|field.ID), data)
summary(M2)

E2 <- resid(M2)
F2 <- fitted(M2)

# fitted values as definde by the fixed part
# gives only the effect of the intercept and covariates.

Betas <- fixef(M2)
X <- model.matrix(M2)
FitManual <- X %*% Betas


# Random effects
RE <- ranef(M2)$field.ID$'(Intercept)'
AllRE  <- RE[as.numeric(data$field.ID)]

M1 <- glmer(anc ~ age_class*scl.dsamcam + scl.mc*scl.cn + scl.ats2 + scl.dgO + (1|field.ID),data=data,family="poisson"); summary(M1)
M2 <- glmer(anc ~ age_class*scl.dsamcam + scl.dgO + (1|field.ID),data=data,family="poisson"); summary(M2)

M1 <- glmmadmb(anc ~ age_class*scl.dsamcam + scl.mc*scl.cn + scl.ats2 + scl.pH*scl.cn + scl.clay +(1|field.ID),data=data,family="poisson"); summary(M1)
M2 <- glmmadmb(anc ~ age_class*scl.dsamcam + scl.dgO + (1|field.ID),data=data,family="poisson"); summary(M2)

plot(data$clay,resid(M1))
plot(data$pH,resid(M1))
plot(data$scl.dsamcam,resid(M1))
plot(data$age_class,predict(M1, type="response"))

AICtab(M1,M2)
anc.best <- M2
```



#### Model Validation
```{r ModelValidation,fig.width=8, fig.height=7}
# Model Validation 
confint(anc.best)
par(mfrow=c(2,2))
par(mar=c(5,5,2,3))
plot(resid(anc.best)~fitted(anc.best)) 
plot(fitted(anc.best) ~predict(anc.best, type="response")) 
plot(predict(anc.best) ~predict(anc.best, type="response")) 
plot(predict(anc.best, type="response") ~ data$anc)
````


#### Extract Predictions and Standard errors for predictions
```{r ExtractPredicitons}
# anc.1.mcmc = glmmadmb(anc ~ age_class + (1|field) + (1|samcam),data=ew.data,family="nbinom", zeroInflation=TRUE, mcmc = TRUE, mcmc.opts = mcmcControl(mcmc = 10000))

td.anc=expand.grid(age_class=levels(data$age_class),
              scl.dsamcam = mean(data$scl.dsamcam),
               scl.dgO = mean(data$scl.dgO))         
pred.anc <- cbind(td.anc,predict(anc.best, td.anc, type="link", se.fit=TRUE),anc.response=predict(anc.best, td.anc, type="response"))

pred.anc <- within(pred.anc, {
  AIC <- AIC(anc.best)
  Rrandom <- summary(lm(fitted(anc.best)~ data$anc))$adj.r.squared
  Rsquared <- summary(lm(predict(anc.best, type="response")~ data$anc))$adj.r.squared
  anc <- 4*exp(fit)
  LL <- 4*exp(fit - 1.96 * se.fit)   
  UL <- 4*exp(fit + 1.96 * se.fit)  
})
head(pred.anc)
range(data$anc)

stat.anc = round(summary(anc.best)$coefficients[, c(3,4)],4)
coef.anc = coeftab(anc.best)

anc.env <- glmmadmb(anc ~ scl.dsamcam + scl.dgO + (1|field.ID),data=data,family="poisson")
anc.pvalue <- anova(anc.env, anc.best)$"Pr(>Chi)"

pred.Stat.anc = cbind(stat.anc,coef.anc,LogLikP=anc.pvalue[2],fixef=fixef(anc.best))
````

```{r}
#write.table(pred.Stat.anc, "Predictions+Stats+ConfIntervals.csv", sep=";", append=TRUE)
#write.table(pred.anc, "Predictions+Stats+ConfIntervals.csv", sep=";", append=TRUE)
```

#### Prediciton plots
```{r AncPredictionPlot}
library(ggplot2)

ggplot(pred.anc, aes(x=age_class, y=anc)) + 
  geom_bar(stat="identity", width=0.5) +
  geom_line(aes(group=anc))+  
  geom_errorbar(aes(ymin=LL, ymax=UL), width=.1) +
  geom_line()


par(mfrow=c(1,1))
par(mar=c(3,3,3,3))
par(oma=c(1,1,1,1))
coefplot2(anc.best)    
```




# Results

### README
```{r CreateREADME.md, }
#setwd("D:/Quentin_Schorpp/Arbeitsprozess/git_repositories/F2_Earthworms/")
knitr::knit(input="README.Rmd", output="README.md") # Error: no such file or directory, when trying knitHTML
```



